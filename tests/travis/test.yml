---
- name: Create containers inventory group
  hosts: localhost
  become: false
  gather_facts: false
  vars:
    containers:
      - xenial
  tasks:
    - name: Build docker images
      docker_image:
        name: "{{ item }}"
        tag: latest
        path: "containers/{{ item }}"
        force: true
      changed_when: false
      loop: "{{ containers }}"

    - name: Run docker containers
      docker_container:
        name: "{{ item }}"
        image: "{{ item }}"
        command: "/sbin/init"
        privileged: true
        exposed_ports: 
          - 9000
        published_ports:
          - 9000
        state: started
      loop: "{{ containers }}"

    - name: Create inventory group on-the-fly
      add_host:
        name: "{{ item }}"
        ansible_connection: docker
        ansible_user: root
        ansible_python_interpreter: python
        groups: containers
      changed_when: false
      loop: "{{ containers }}"

- name: Setup PostgreSQL
  hosts: containers
  become: True
  tasks:
    - name: Install PostgreSQL and requirements
      apt:
        name: "{{ item }}"
        state: present
        update_cache: yes
      loop:
        - postgresql
        - python3-psycopg2

    - name: Start PostgreSQL
      systemd:
        name: postgresql
        state: started

    - name: Create sonar database user
      postgresql_user:
        name: sonar
        password: sonar
        state: present 
      become: True
      become_user: postgres

    - name: Create sonar database
      postgresql_db:
        name: sonar
        owner: sonar
        encoding: UTF-8
        template: template0
        state: present
      become: True
      become_user: postgres

- name: Apply ansible-sonar role
  hosts: containers
  become: True
  roles:
    - role: ansible-sonar